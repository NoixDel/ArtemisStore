<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Apps Admin (dev only)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    textarea{min-height:90px}
    .btn-icon { white-space: nowrap }
  </style>
</head>
<body class="container py-4">
<h1 class="mb-4">Gestionnaire d'Applications (dev)</h1>

<form id="addForm" class="row g-2 mb-4">
  <div class="col-md-4"><input class="form-control" id="name" placeholder="Nom" required /></div>
  <div class="col-md-4"><input class="form-control" id="editor" placeholder="√âditeur" required /></div>
  <div class="col-md-4"><input class="form-control" id="iconUrl" placeholder="URL ic√¥ne (optionnel)" /></div>

  <div class="col-12"><textarea class="form-control" id="description" placeholder="Description" required></textarea></div>

  <div class="col-md-3"><input class="form-control" id="category" placeholder="Cat√©gorie" list="dl-categories" required /></div>
  <div class="col-md-3"><input class="form-control" id="source" placeholder="Source" list="dl-sources" required /></div>
  <div class="col-md-3"><input class="form-control" id="appid" placeholder="AppID" required /></div>
  <div class="col-md-3"><input class="form-control" id="argument" placeholder="Argument" /></div>

  <div class="col-md-3"><input type="number" class="form-control" id="popularity" placeholder="Popularit√© (0..10)" required /></div>
  <div class="col-md-3 form-check mt-2 ms-2">
    <input type="checkbox" class="form-check-input" id="is_cracked">
    <label class="form-check-label" for="is_cracked">Crack√©</label>
  </div>
  <div class="col-md-3 form-check mt-2 ms-2">
    <input type="checkbox" class="form-check-input" id="needadm">
    <label class="form-check-label" for="needadm">Besoin d'admin</label>
  </div>

  <div class="col-12 d-flex gap-2">
    <button class="btn btn-primary">Ajouter</button>
    <button type="button" class="btn btn-secondary" id="msstoreFill">Auto (MS Store)</button>
  </div>
</form>

<!-- DATALISTS -->
<datalist id="dl-categories"></datalist>
<datalist id="dl-sources">
  <option value="msstore"></option>
  <option value="winget"></option>
  <option value="chocolatey"></option>
  <option value="direct"></option>
  <option value="steam"></option>
  <option value="epic"></option>
</datalist>

<table class="table table-striped" id="tbl">
  <thead>
    <tr>
      <th>Nom</th><th>√âditeur</th><th>Ic√¥ne</th><th>Description</th>
      <th>Crack√©</th><th>Source</th><th>Cat√©gorie</th><th>AppID</th>
      <th>Arg</th><th>Pop</th><th>Admin</th><th>Actions</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>

<script>
const API = (p, o={}) => fetch(p, o).then(r => r.json());
const base64FromUrl = async (u) => {
  if (!u) return '';
  const arr = await fetch(u).then(r => r.arrayBuffer());
  return btoa(String.fromCharCode(...new Uint8Array(arr)));
};

function addOptionOnce(parent, value, seen) {
  if (!value || seen.has(value)) return;
  seen.add(value);
  const opt = document.createElement('option');
  opt.value = value;
  parent.appendChild(opt);
}

async function refresh() {
  const rows = await API('/api/list');

  // Alimenter datalists
  const dlCat = document.getElementById('dl-categories');
  const dlSrc = document.getElementById('dl-sources');
  const seenCat = new Set([...Array.from(dlCat.children)].map(x => x.value));
  const seenSrc = new Set([...Array.from(dlSrc.children)].map(x => x.value));
  rows.forEach(r => {
    addOptionOnce(dlCat, r.category, seenCat);
    addOptionOnce(dlSrc, r.source, seenSrc);
  });

  // Tableau
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  rows.forEach(app => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="form-control form-control-sm" value="${app.name}"></td>
      <td><input class="form-control form-control-sm" value="${app.editor}"></td>
      <td class="d-flex align-items-center gap-2">
        ${app.icon ? `<img width="40" height="40" src="data:image/png;base64,${app.icon}">` : ''}
        <button class="btn btn-outline-secondary btn-sm btn-icon">üñºÔ∏è from URL</button>
      </td>
      <td><textarea class="form-control form-control-sm">${app.description}</textarea></td>
      <td class="text-center"><input type="checkbox" ${app.is_cracked ? 'checked' : ''}></td>
      <td><input class="form-control form-control-sm" value="${app.source}" list="dl-sources"></td>
      <td><input class="form-control form-control-sm" value="${app.category}" list="dl-categories"></td>
      <td><input class="form-control form-control-sm" value="${app.appid}"></td>
      <td><input class="form-control form-control-sm" value="${app.argument}"></td>
      <td><input type="number" class="form-control form-control-sm" value="${app.popularity}"></td>
      <td class="text-center"><input type="checkbox" ${app.needadm ? 'checked' : ''}></td>
      <td class="d-flex gap-1">
        <button class="btn btn-sm btn-primary">Update</button>
        <button class="btn btn-sm btn-danger">Del</button>
      </td>
    `;

    const cells = tr.querySelectorAll('td');
    const inName      = cells[0].querySelector('input');
    const inEditor    = cells[1].querySelector('input');
    const btnIconUrl  = cells[2].querySelector('button');
    const inDesc      = cells[3].querySelector('textarea');
    const inCracked   = cells[4].querySelector('input[type="checkbox"]');
    const inSource    = cells[5].querySelector('input');
    const inCategory  = cells[6].querySelector('input');
    const inAppid     = cells[7].querySelector('input');
    const inArg       = cells[8].querySelector('input');
    const inPop       = cells[9].querySelector('input');
    const inNeedAdm   = cells[10].querySelector('input[type="checkbox"]');
    const btnUpdate   = cells[11].querySelector('.btn-primary');
    const btnDelete   = cells[11].querySelector('.btn-danger');

    btnIconUrl.onclick = async () => {
      const url = prompt('URL de la nouvelle ic√¥ne ?');
      if (!url) return;
      try {
        const iconB64 = await base64FromUrl(url);
        await API('/api/update', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            id: app.id,
            name: inName.value,
            editor: inEditor.value,
            icon: iconB64,
            description: inDesc.value,
            is_cracked: inCracked.checked,
            source: inSource.value,
            category: inCategory.value,
            appid: inAppid.value,
            argument: inArg.value,
            popularity: Number(inPop.value)||0,
            needadm: inNeedAdm.checked
          })
        });
        refresh();
      } catch {
        alert('Impossible de r√©cup√©rer cette ic√¥ne.');
      }
    };

    btnUpdate.onclick = async () => {
      await API('/api/update', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          id: app.id,
          name: inName.value,
          editor: inEditor.value,
          icon: null,
          description: inDesc.value,
          is_cracked: inCracked.checked,
          source: inSource.value,
          category: inCategory.value,
          appid: inAppid.value,
          argument: inArg.value,
          popularity: Number(inPop.value)||0,
          needadm: inNeedAdm.checked
        })
      });
      refresh();
    };

    btnDelete.onclick = async () => {
      await API('/api/delete', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ id: app.id })
      });
      refresh();
    };

    tbody.appendChild(tr);
  });
}

document.getElementById('addForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const v = (id) => document.getElementById(id).value.trim();
  const iconUrl = v('iconUrl');
  const icon = iconUrl ? await base64FromUrl(iconUrl) : '';

  await API('/api/add', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      name: v('name'),
      editor: v('editor'),
      icon,
      description: v('description'),
      is_cracked: document.getElementById('is_cracked').checked,
      source: v('source'),
      category: v('category'),
      appid: v('appid'),
      argument: v('argument'),
      popularity: Number(v('popularity')) || 0,
      needadm: document.getElementById('needadm').checked
    })
  });
  e.target.reset();
  refresh();
});

document.getElementById('msstoreFill').addEventListener('click', async () => {
  const q = document.getElementById('name').value.trim();
  if (!q) return;
  const d = await API('/api/msstore?q='+encodeURIComponent(q));
  if (!d) return;
  const set = (id, val) => document.getElementById(id).value = val ?? '';
  set('name', d.name);
  set('editor', d.editor);
  set('iconUrl', d.icon);
  set('description', d.description);
  set('source', d.source);
  set('appid', d.appid);
  set('category', d.category);
  set('argument', d.argument);
  document.getElementById('popularity').value = d.popularity ?? 0;
});

refresh();
</script>
</body>
</html>
